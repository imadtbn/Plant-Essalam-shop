<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>مشتلة السلام 🌱</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body {font-family: 'Tajawal', sans-serif; margin:0; background:#f9f9f9; color:#333;}
    header {background:#2e7d32; color:#fff; padding:1rem; text-align:center;}
    h1 {margin:0; font-size:1.8rem;}
    .products {display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:15px; padding:20px;}
    .card {background:#fff; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); padding:15px; text-align:center;}
    .card img {width:100%; height:160px; object-fit:cover; border-radius:10px;}
    .card h3 {margin:10px 0; font-size:1.2rem;}
    .card p {margin:5px 0; color:#555;}
    .btn {background:#2e7d32; color:#fff; padding:8px 12px; border:none; border-radius:6px; cursor:pointer;}
    .btn:hover {background:#1b5e20;}
    #cart {position:fixed; bottom:20px; left:20px; background:#fff; border-radius:50%; width:60px; height:60px; display:flex; align-items:center; justify-content:center; box-shadow:0 2px 6px rgba(0,0,0,0.2); cursor:pointer;}
    #cart span {background:#c62828; color:#fff; font-size:14px; padding:2px 6px; border-radius:10px; position:absolute; top:8px; right:8px;}
    .cart-modal {position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center;}
    .cart-content {background:#fff; padding:20px; border-radius:10px; width:90%; max-width:500px;}
    .cart-content h2 {margin-top:0;}
    .cart-item {display:flex; justify-content:space-between; padding:5px 0; border-bottom:1px solid #eee;}
    .checkout {margin-top:15px; text-align:center;}
    input, textarea {width:100%; padding:8px; margin:5px 0; border:1px solid #ddd; border-radius:6px;}
  </style>
</head>
<body>
  <header>
    <h1>🌱 مشتلة السلام</h1>
  </header>

  <section class="products" id="products"></section>

  <!-- زر السلة -->
  <div id="cart"><i class="fas fa-shopping-cart fa-lg"></i><span id="cart-count">0</span></div>

  <!-- نافذة السلة -->
  <div class="cart-modal" id="cart-modal">
    <div class="cart-content">
      <h2>🛒 سلة المشتريات</h2>
      <div id="cart-items"></div>
      <div class="checkout">
        <h3>معلومات الزبون</h3>
        <input type="text" id="customerName" placeholder="الاسم الكامل" required>
        <input type="tel" id="customerPhone" placeholder="رقم الهاتف" required>
        <textarea id="customerAddress" placeholder="العنوان"></textarea>
        <button class="btn" onclick="submitOrder()">تأكيد الطلب</button>
        <button class="btn" style="background:#c62828" onclick="closeCart()">إغلاق</button>
      </div>
    </div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxMYSinB7TRS-wtpunBOT9Telb6pKAMvuRTWfc12elRnvcwsO0VUT1s0arOfG-S9-vPHA/exec";
    let cart = [];

    // تحميل المنتجات
    async function loadProducts() {
      const res = await fetch(API_URL + "?action=getProducts");
      const data = await res.json();
      const container = document.getElementById("products");
      container.innerHTML = "";
      data.forEach(p => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <img src="${p.image || 'https://via.placeholder.com/200x160'}" alt="">
          <h3>${p.name}</h3>
          <p>الفئة: ${p.category}</p>
          <p>السعر: ${p.price} دج</p>
          <button class="btn" onclick='addToCart(${JSON.stringify(p)})'>إضافة للسلة</button>
        `;
        container.appendChild(card);
      });
    }

    // إضافة للسلة
    function addToCart(product) {
      cart.push(product);
      document.getElementById("cart-count").innerText = cart.length;
    }

    // فتح السلة
    document.getElementById("cart").onclick = () => {
      document.getElementById("cart-modal").style.display = "flex";
      renderCart();
    };

    function renderCart() {
      const container = document.getElementById("cart-items");
      container.innerHTML = "";
      let total = 0;
      cart.forEach((item,i)=>{
        total += parseFloat(item.price);
        container.innerHTML += `<div class="cart-item">
          <span>${item.name}</span>
          <span>${item.price} دج</span>
        </div>`;
      });
      container.innerHTML += `<div class="cart-item"><strong>المجموع</strong> <strong>${total} دج</strong></div>`;
    }

    function closeCart(){document.getElementById("cart-modal").style.display="none";}

    // إرسال الطلب
    async function submitOrder(){
      const name = document.getElementById("customerName").value.trim();
      const phone = document.getElementById("customerPhone").value.trim();
      const address = document.getElementById("customerAddress").value.trim();
      if(!name || !phone){alert("الرجاء إدخال الاسم والهاتف"); return;}
      const order = {
        customerName:name,
        customerPhone:phone,
        customerAddress:address,
        items: cart.map(i=>i.name).join(", "),
        total: cart.reduce((t,i)=>t+parseFloat(i.price),0)
      };
      const res = await fetch(API_URL+"?action=addOrder",{
        method:"POST",
        body: JSON.stringify(order)
      });
      const msg = await res.text();
      alert("✅ تم إرسال الطلب بنجاح");
      cart=[]; document.getElementById("cart-count").innerText=0;
      closeCart();
    }

    loadProducts();
  </script>
</body>
</html>
