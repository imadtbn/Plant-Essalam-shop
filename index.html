<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>مشتلة السلام</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body{font-family:'Tajawal',Arial,sans-serif;margin:0;background:#f8fdf8}
    header{background:#2e7d32;color:#fff;padding:1rem;text-align:center;position:sticky;top:0;z-index:100}
    nav{margin-top:.5rem}
    nav a{color:#fff;margin:0 .5rem;text-decoration:none;font-weight:bold}
    nav a:hover{text-decoration:underline}

    #search-bar{display:flex;justify-content:center;margin:1rem}
    #search-input{width:70%;padding:.5rem;border:1px solid #ccc;border-radius:5px}

    .category{padding:1rem}
    .products{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:1rem}
    .card{background:#fff;border:1px solid #ddd;border-radius:10px;padding:1rem;text-align:center;display:flex;flex-direction:column;justify-content:space-between}
    .card img{width:100%;height:150px;object-fit:cover;border-radius:8px}
    .btn{background:#2e7d32;color:#fff;border:none;padding:.5rem 1rem;border-radius:5px;cursor:pointer;margin-top:.5rem}
    .btn:hover{background:#1b5e20}

    footer{background:#2e7d32;color:#dfeede;text-align:center;padding:1rem;margin-top:2rem}

    /* السلة */
    #cart{background:#fff;border:2px solid #2e7d32;position:sticky;top:70px;margin:1rem;padding:1rem;border-radius:8px}
    #cart h3{margin-top:0}
    #cart table{width:100%;border-collapse:collapse}
    #cart th,#cart td{border:1px solid #ddd;padding:.3rem;text-align:center}
    #cart tfoot td{font-weight:bold}
    #checkout{margin-top:1rem}
    .form-group{margin:.5rem 0}
    .form-group input{width:100%;padding:.5rem;border:1px solid #ccc;border-radius:5px}
    .checkout-btns{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem}
    .checkout-btns button{flex:1}
  </style>
</head>
<body>

<header>
  <h1><i class="fas fa-seedling"></i> مشتلة السلام</h1>
  <nav>
    <a href="#products">المنتجات</a>
    <a href="#about">حولنا</a>
    <a href="#contact">التواصل</a>
  </nav>
</header>

<!-- البحث -->
<div id="search-bar">
  <input type="text" id="search-input" placeholder="🔍 ابحث عن منتج..." oninput="filterProducts()">
</div>

<main style="display:flex;flex-wrap:wrap;align-items:flex-start">
  <!-- المنتجات -->
  <div id="categories-container" style="flex:3;min-width:60%">
    <p style="text-align:center;padding:2rem;">⏳ جارٍ تحميل المنتجات...</p>
  </div>

  <!-- السلة -->
  <div id="cart" style="flex:1;min-width:35%">
    <h3><i class="fas fa-shopping-cart"></i> السلة</h3>
    <table>
      <thead><tr><th>المنتج</th><th>الكمية</th><th>السعر</th></tr></thead>
      <tbody id="cart-body"></tbody>
      <tfoot><tr><td colspan="2">المجموع</td><td id="cart-total">0</td></tr></tfoot>
    </table>
    <div id="checkout">
      <div class="form-group"><input id="customerName" placeholder="👤 الاسم الكامل"></div>
      <div class="form-group"><input id="customerPhone" placeholder="📞 رقم الهاتف"></div>
      <div class="form-group"><input id="customerAddress" placeholder="📍 العنوان"></div>
      <div class="checkout-btns">
        <button class="btn" onclick="checkout('whatsapp')">شراء عبر واتساب</button>
        <button class="btn" onclick="checkout('google')">شراء عبر Google</button>
      </div>
    </div>
  </div>
</main>

<footer>
  <p>© 2025 مشتلة السلام — جميع الحقوق محفوظة</p>
</footer>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbxMYSinB7TRS-wtpunBOT9Telb6pKAMvuRTWfc12elRnvcwsO0VUT1s0arOfG-S9-vPHA/exec";
let allProducts=[],cart=[];

async function loadProducts(){
  const res=await fetch(API_URL+"?sheet=products");
  allProducts=await res.json();
  renderProducts(allProducts);
}

function renderProducts(products){
  const container=document.getElementById("categories-container");
  container.innerHTML="";
  const grouped={};
  products.forEach(p=>{
    const cat=(p["الفئة "]||"غير مصنف").trim();
    (grouped[cat] ||= []).push(p);
  });
  Object.entries(grouped).forEach(([cat,items])=>{
    const section=document.createElement("section");
    section.className="category";
    section.innerHTML=`<div class="category-header"><h2><i class="fas fa-leaf"></i> ${cat}</h2></div><div class="products"></div>`;
    const wrap=section.querySelector(".products");
    items.forEach(p=>{
      const card=document.createElement("div");
      card.className="card";
      card.innerHTML=`
        <img src="${p["رابط الصورة"]||'https://via.placeholder.com/200x150'}">
        <h3>${p["اسم المنتج"]}</h3>
        <p>${p["السعر "]} دج</p>
        <button class="btn">إضافة للسلة</button>`;
      card.querySelector("button").onclick=()=>addToCart(p);
      wrap.appendChild(card);
    });
    container.appendChild(section);
  });
}

function filterProducts(){
  const q=document.getElementById("search-input").value.trim();
  const results=allProducts.filter(p=>p["اسم المنتج"].includes(q)||p["الفئة "].includes(q));
  renderProducts(results);
}

function addToCart(product){
  const existing=cart.find(i=>i.id===product.id);
  if(existing){existing.qty++;}
  else{cart.push({id:product.id,name:product["اسم المنتج"],price:product["السعر "],qty:1});}
  renderCart();
}

function renderCart(){
  const body=document.getElementById("cart-body");body.innerHTML="";
  let total=0;
  cart.forEach(item=>{
    total+=item.price*item.qty;
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${item.name}</td>
      <td><input type="number" value="${item.qty}" min="1" style="width:50px" onchange="updateQty(${item.id},this.value)"></td>
      <td>${item.price*item.qty}</td>`;
    body.appendChild(tr);
  });
  document.getElementById("cart-total").innerText=total;
}

function updateQty(id,val){
  const it=cart.find(i=>i.id===id);
  if(it){it.qty=parseInt(val)||1;}
  renderCart();
}

function checkout(method){
  const name=document.getElementById("customerName").value.trim();
  const phone=document.getElementById("customerPhone").value.trim();
  const address=document.getElementById("customerAddress").value.trim();
  if(!name||!phone||cart.length===0){alert("⚠️ أدخل البيانات وأضف منتجات");return;}

  const itemsStr=cart.map(i=>`${i.name} x${i.qty}`).join(", ");
  const total=cart.reduce((s,i)=>s+i.price*i.qty,0);

  // إرسال إلى Google Sheets
  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"addOrder",
      customerName:name,
      phone:phone,
      customerAddress:address,
      items:itemsStr,
      total:total,
      status:"جديد"
    })
  });

  if(method==="whatsapp"){
    const msg=`طلب جديد:%0A👤 ${name}%0A📞 ${phone}%0A📍 ${address}%0A🛒 ${itemsStr}%0A💰 ${total} دج`;
    window.open(`https://wa.me/213697743721?text=${msg}`,"_blank");
  }else{
    alert("✅ تم إرسال الطلب إلى المشتلة بنجاح!");
  }
  cart=[];renderCart();
}

loadProducts();
</script>

</body>
</html>
